</head>
<link rel="stylesheet" href="css/specialist-page.css">
<title>Specialist List</title>
</head>

<body>
    <!-- Container for whole page -->
    <div class="container-fluid">
        <div class="main-row wrapper">
            <!-- Navigation bar -->

            <main>
                <div class="alertContainer"></div>
                <center style="padding-top: 40px; font-size: xx-large; font-weight: bolder;">Specialist Page</center>

                <div class="wrapper">
                    <div class="third-row"></div>
                    <div class="third-row search-row" id="search-col">
                        <!-- Search bar -->
                        <div class="wrapper">
                            <div class="input-extended input-extended-left search-input">
                                <span class="input-extension-left" id="search-addon"><i class="fas fa-search"></i></span>
                                <!-- Search input -->
                                <input autocomplete="off" onkeyup="ticketSearch();" id="ticket-search" type="text" placeholder="Search..." aria-label="search" aria-describedby="search-addon">
                                <!-- Select to choose field to search by -->
                                <select onchange="ticketSearch();" class="input-extension-right" id="search-dropdown" aria-label="Default select example">
                                    <option value="ID" selected>ID</option>
                                    <option value="description">Description</option>
                                    <option value="Software">Software</option>
                                    <option value="Hardware">Hardware</option>
                                    <option value="Reporter">Reporter</option>
                                </select>
                            </div>
                        </div>
                        <!-- Help text below search bar -->
                        <div class="full-row">
                            <div id="search-help">Search for ticket by ID, description or personnel</div>
                        </div>
                    </div>
                </div>

                <!-- View ticket modal -->
                <div id="view-ticket-modal" class="modal fade" tabindex="-1">
                    <div class="modal-dialog">
                        <form id="update-form" name="update-form" action="ticket-list.php" method="POST" class="modal-form">
                            <!-- Invisible field used for post back to same page -->
                            <input type="hidden" name="form_type" value="update-ticket">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h3 class="modal-title">View ticket</h3>
                                    <button type="button" onclick="closeModal();" class="modal-close button-close" data-bs-dismiss="modal" aria-label="Close"><i class="fas fa-times"></i></button>
                                </div>
                                <hr>
                                <div class="modal-body">
                                    <div class="wrapper">
                                        <!-- Ticket ID (automatically generated so cannot be edited) -->
                                        <div class="half-row">
                                            <label for="viewID">Ticket ID</label>
                                            <input id="viewID" name="ID" type="number" placeholder="" value="" required disabled>
                                        </div>
                                        <!-- Created timestamp of the ticket (not editable) -->
                                        <div class="half-row">
                                            <label for="viewCreatedTimestamp">Created Timestamp</label>
                                            <input id="viewCreatedTimestamp" name="createdTimestamp" type="text" placeholder="" disabled>
                                        </div>
                                        <!-- Dropdown list of reporters -->
                                        <div class="full-row">
                                            <label for="viewReporterID">Reporter</label>
                                            <div class="input-extended input-extended-right">
                                                <select onchange="getPhoneNo(this);" id="viewReporterID" name="reporterID" class="personnel-select " <?=$ _SESSION[ 'deptName']=='Operator' ? '' : 'disabled' ?>>
                                                    <!-- Add all reporters from database as items to select -->
                                                        <option value=<?= $personnel->ID ?>><?= $personnel->FullName ?></option>
                                                </select>
                                                <!-- Selected reporter phone number (not editable) -->
                                                <label class="input-extension-right" for="reporterID" id="viewReporterNo"></label>
                                            </div>
                                        </div>
                                        <!-- Dropdown list of operators -->
                                        <div class="full-row">
                                            <label for="viewOperatorID">Phone Operator</label>
                                            <div class="input-extended input-extended-right">
                                                <select onchange="getPhoneNo(this);" id="viewOperatorID" name="operatorID" class="personnel-select " <?=$ _SESSION[ 'deptName']=='Operator' ? '' : 'disabled' ?>>
                                                    <!-- Add all operators from database as items to select -->
                                                        <option value=<?= $operator->ID ?>><?= $operator->Workload ?>) <?= $operator->FullName ?></option>
                                                </select>
                                                <!-- Selected operator phone number (not editable) -->
                                                <label class="input-extension-right" for="operatorID" id="viewOperatorNo"></label>
                                            </div>
                                        </div>
                                        <!-- Dropdown list of specialist -->
                                        <div class="full-row">
                                            <label for="viewAssignedSpecialistID">Assigned Specialist</label>
                                            <div class="input-extended input-extended-right">
                                                <select onchange="getPhoneNo(this); addExternalSpecialist(this)" id="viewAssignedSpecialistID" name="assignedSpecialistID" <?=( $_SESSION[ 'deptName']=="Specialist" ? "disabled" : "") ?> class="personnel-select ">
                                                    <option selected value=0>Not assigned</option>
                                                    <!-- Option to add external specialist -->
                                                    <option value=-1>New External Specialist</option>
                                                    <!-- Add all specialists from database as items to select -->
                                                        <option ></option>
                                                </select>
                                                <!-- Selected specialist phone number (not editable) -->
                                                <label class="input-extension-right" for="specialistID" id="viewSpecialistNo"></label>
                                            </div>
                                        </div>
                                        <!-- Textbox to add new external specialist -->
                                        <div class="full-row newExternalSpecialistCol">
                                            <div class="half-row">
                                                <label for="newExternalSpecialistText">New External Specialist Name</label>
                                                <input id="newExternalSpecialistText" name="newExternalSpecialistText" type="text" placeholder="">
                                            </div>
                                            <div class="half-row">
                                                <label for="newExternalSpecialistPhoneNo">New External Specialist Phone No</label>
                                                <input id="newExternalSpecialistPhoneNo" name="newExternalSpecialistPhoneNo" type="number" placeholder="">
                                            </div>
                                            <div class="half-row">
                                                <label for="newExternalSpecialistPassword">New External Specialist Password</label>
                                                <input id="newExternalSpecialistPassword" name="newExternalSpecialistPassword" type="text" placeholder="">
                                            </div>
                                            <div class="half-row">
                                                <label for="newExternalSpecialistSpeciality">New External Specialist Speciality</label>
                                                <select id="newExternalSpecialistSpeciality" name="newExternalSpecialistSpeciality">
                                                    <!-- Add all problem types from database to select as items -->
                                                        <option ></option>
                                                </select>
                                            </div>
                                        </div>
                                        <!-- Dropdown list of priorities for the ticket -->
                                        <div class="half-row">
                                            <label for="viewTicketPriority">Priority</label>
                                            <select id="viewTicketPriority" name="ticketPriority">
                                                <option value=1>1 (Lowest)</option>
                                                <option value=2>2</option>
                                                <option value=3>3</option>
                                                <option value=4>4</option>
                                                <option value=5>5 (Highest)</option>
                                            </select>
                                        </div>
                                        <!-- Dropdown list of states for the ticket -->
                                        <div class="half-row">
                                            <label for="viewTicketState">State</label>
                                            <select id="viewTicketState" name="ticketState">
                                                <option value="TODO">TODO</option>
                                                <option value="INPROGRESS">IN PROGRESS</option>
                                                <option value="INREVIEW">IN REVIEW</option>
                                                <option value="RESOLVED">RESOLVED</option>
                                            </select>
                                        </div>
                                        <!-- Dropdown list of problem types -->
                                        <div class="half-row">
                                            <!-- Need to include an option here for "other" and allow custom input -->
                                            <label for="viewTypeID">Problem type</label>
                                            <select onchange="addNewType(this);" id="viewTypeID" name="typeID">
                                                <option value=-1>New</option>
                                                <!-- Add all problem types from database as items to select -->
                                                    <!-- Option to add new problem type -->
                                                    <option ></option>
                                            </select>
                                        </div>
                                        <!-- Textbox to add new problem Type -->
                                        <div class="full-row newTypeCol">
                                            <label for="newTypeText">New Type Explanation</label>
                                            <input id="newTypeText" name="newTypeText" type="text" placeholder="">
                                        </div>
                                        <!-- Text area for ticket description -->
                                        <div class="full-row">
                                            <label for="description">Description</label>
                                            <textarea type="text" id="viewTicketDescription" name="ticketDescription" placeholder="" maxlength="255" required></textarea>
                                        </div>
                                        <!-- Dropdown list of software -->
                                        <div class="software-input half-row">
                                            <label for="viewSoftwareID">Software</label>
                                            <select id="viewSoftwareID" name="softwareID">
                                                <option value=0>Problem is not software related</option>
                                                <!-- Add all software from database as items to select -->
                                                    <option></option>
                                            </select>
                                        </div>
                                        <!-- Dropdown list of hardware -->
                                        <div class="hardware-input half-row">
                                            <label for="viewHardwareID">Hardware</label>
                                            <select id="viewHardwareID" name="hardwareID">
                                                <option value=0>Problem is not hardware related</option>
                                                <!-- Add all hardware from database as items to select -->
                                                    <option value=1></option>
                                            </select>
                                        </div>
                                        <!-- Dropdown list of solutions -->
                                        <div class="full-row">
                                            <label for="viewFinalSolutionID">Solution</label>
                                            <select onchange="addNewSolution(this);" id="viewFinalSolutionID" name="finalSolutionID">
                                                <option selected value=0>Solution has not been provided</option>
                                                <!-- Option to add new solution -->
                                                <option value=-1>New</option>
                                                <!-- Add all solutions from database as items to select -->
                                                    <option value=1></option>
                                            </select>
                                        </div>
                                        <!-- Textbox to add new solution description -->
                                        <div class="full-row newSolutionCol">
                                            <label for="newSolutionText">New Solution Explanation</label>
                                            <input id="newSolutionText" name="newSolutionText" type="text" placeholder="">
                                        </div>
                                        <!-- Resolved timestamp (not editable as automatically generated) -->
                                        <div class="full-row">
                                            <label for="viewResolvedTimestamp">Resolved Timestamp</label>
                                            <input id="viewResolvedTimestamp" name="resolvedTimestamp" disabled type="text" placeholder="">
                                        </div>
                                    </div>
                                </div>
                                <!-- Button group to either cancel or submit ticket -->
                                <hr>
                                <div class="modal-footer">
                                    <button type="button" onclick="closeModal();" class="modal-close button-close-bottom" data-bs-dismiss="modal">Close</button>
                                    <button type="submit">Update ticket</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                <!-- Table that contains tickets -->
                <table id="myTable">
                    <thead>
                        <!-- Table headers -->
                        <tr>
                            <th>PROBLEM TYPE</th>
                            <th>TODO</th>
                            <th>ACTIVE</th>
                            <th>RESOLVED</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- For each type of problem, generate a row -->
                        <input value=<% Object.stringify(data)%>>

                        <% for (var i =0; i <data.problemType.length;  i++ ) { %>
                            <tr>
                                <th scope="wrapper">
                                    <%= data.problemType[i] %>
                                </th>

                                <!-- For each state, generate tickets -->
                                <% 
                                const states = ["TODO", "ACTIVE", "RESOLVED"];
                                states.forEach(state => {
                                %>
                                    <td ondragover="onDragOver(event)" ondrop="onDrop(event)">
                                        <ul class="ticket-list" data-state="<%state%>" datatypeID="<%data.problemType[i]%>">
                                            <% for (var u =0; u < Object.keys(data.data).length;  u++ ) { %>
                                                <%if (data.data[u].ticketstate == state && data.data[u].maintag == data.problemType[i]) { %>
                                                    <li onclick="showTicket()" class="ticket" id="ticket" draggable="true" ondragstart="onDragStart(event)" data-ID="<%= data.data[u].id %>" data-Description="<%= data.data[u].ticketdescription %>" data-Reporter="<%= data.data[u].userid %>" data-AssignedSpecialistID="<%= data.data[u].assignedspecialist %>">
                                                        <div class="ticket-body">
                                                            <p class="ticket-id">
                                                                <%= data.data[u].id %>
                                                            </p>
                                                            <hr>
                                                            <h4 class="ticket-reporter">
                                                                <%= data.data[u].userid %>
                                                            </h4>
                                                            <p class="ticket-description">
                                                                <%= data.data[u].ticketdescription %>
                                                            </p>
                                                        </div>
                                                    </li>
                                                    <% }} %>
                                        </ul>
                                    </td>
                                    <% }); %>
                            </tr>
                            <% } %>

                    </tbody>
                </table>
            </main>
        </div>
    </div>

    <!-- JS -->
    <script src="js/ticket-list.js"></script>